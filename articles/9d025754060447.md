---
title: "Nginxã«ã¦å˜ä¸€ãƒãƒ¼ãƒˆç•ªå·ä¸Šã§SSLã¨éSSLãƒ—ãƒ­ãƒˆã‚³ãƒ«ä¸¡æ–¹ã‚’å—ã‘ä»˜ã‘ã‚‹"
emoji: "ğŸ¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nginx"]
published: false
---

# ã‚„ã‚ŠãŸã„ã“ã¨

Nginxã«ã¦å˜ä¸€ã®ãƒãƒ¼ãƒˆç•ªå·ä¸Šã§SSLã¨éSSLã®ã©ã¡ã‚‰ã§ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚

é€šå¸¸ã®httpãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ã®è¨­å®šã§ã¯åŒã˜ãƒãƒ¼ãƒˆç•ªå·ã§SSLã¨éSSLã®ä¸¡æ–¹ã‚’å—ã‘ä»˜ã‘ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚

ä¸Šè¨˜ãŒå¿…è¦ãªã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€ç¾åœ¨SSLçµ‚ç«¯ã‚’æ‹…ã£ã¦ã„ã‚‹Nginxã‚ˆã‚Šã‚‚ä¸Šä½ã«SSLçµ‚ç«¯ã‚’å®Ÿæ–½ã™ã‚‹ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µã‚’é…ç½®ã—ãŸã„éš›ã«ã€ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã§æ§‹ç¯‰ã—ãŸã„ã‚±ãƒ¼ã‚¹ãŒã‚ã£ãŸã€‚

# å®Ÿç¾æ–¹æ³•

Nginx 1.15.2 ã‹ã‚‰å°å…¥ã•ã‚ŒãŸ`stream_ssl_preread`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã®`$ssl_preread_protocol`å¤‰æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§SSLé€šä¿¡æ™‚ã®initial ClientHelloã‚’è¦‹ã¦HTTPã‹HTTPSã‹ã‚’äº‹å‰ã«åˆ¤å®šã™ã‚‹ã€‚ãã‚Œã«ã‚ˆã‚Šã€è¡¨å´ã®stream(TCPé€šä¿¡)ã«ã¦å˜ä¸€ãƒãƒ¼ãƒˆç•ªå·ã§å—ã‘ä»˜ã‘ã¦ã‚‚è£å´(Upstream)ã¸ã®è»¢é€ã‚’SSLã‹éSSLã‹ã«åˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

ã“ã®å†…å®¹ã®è©³ç´°ã¯ä»¥ä¸‹ã®å…¬å¼ãƒ–ãƒ­ã‚°ã‚’å‚ç…§ã€‚

https://www.nginx.com/blog/running-non-ssl-protocols-over-ssl-port-nginx-1-15-2/

# å®Ÿè£…å†…å®¹

ä»¥ä¸‹ã®å†…å®¹ã«ã¦ãƒãƒ¼ãƒˆç•ªå·ãŒ4ã¤ã‚‚ç™»å ´ã—ã€ã‚„ã‚„ã“ã—ã„ã®ã§ä»¥ä¸‹ã«ã¾ã¨ã‚ã¾ã™ã€‚

* :8080 â†’ Nginxã‚µãƒ¼ãƒã®è¡¨å´ã§ã‚ã‚‹stream(TCPé€šä¿¡)ãŒå—ã‘ä»˜ã‘ã‚‹ãƒãƒ¼ãƒˆç•ªå·
* :8081 â†’ upstreamå´ã‹ã‚‰æ›´ã«æœ€çµ‚çš„ã«å—ã‘æ¸¡ã—ãŸã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãŒå—ã‘ä»˜ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·
* :8082 â†’ streamãŒå—ã‘æ¸¡ã™upstreamå´ã®HTTPé€šä¿¡ã®ãƒãƒ¼ãƒˆç•ªå·
* :8083 â†’ streamãŒå—ã‘æ¸¡ã™upstreamå´ã®HTTPSé€šä¿¡(SSL)ã®ãƒãƒ¼ãƒˆç•ªå·

stream(TCP)å´ã®è¨­å®šãŒä»¥ä¸‹ã€‚

#### `/etc/nginx/nginx.conf`

```nginx
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}

stream {
    upstream http {
        server localhost:8082; # HTTPé€šä¿¡ã®å ´åˆã¯8082ãƒãƒ¼ãƒˆã¸è»¢é€
    }

    upstream https {
        server localhost:8083; # HTTPSé€šä¿¡ã®å ´åˆã¯8083ãƒãƒ¼ãƒˆã¸è»¢é€
    }

    map $ssl_preread_protocol $upstream { # SSLé€šä¿¡æ™‚ã®initial ClientHelloã®å†…å®¹ãŒ$ssl_preread_protocolã«å…¥ã‚Š$upstreamå¤‰æ•°ã«å€¤ãŒå…¥ã‚‹ã€‚
        default https;                    # SSLé€šä¿¡ã‚’æ¤œçŸ¥ã—ãŸã‚‰ $upstream = https
        "" http;                          # SSLé€šä¿¡ã§ç„¡ã„å ´åˆã¯ $upstream = http
    }

    server {                  # stream(TCPé€šä¿¡)ã®ã‚µãƒ¼ãƒè¨­å®š
        listen 8080;
        proxy_pass $upstream; # ä¸Šè¨˜ã®mapè¨­å®šã«ã‚ˆã£ã¦$upstreamã¯httpsã‹httpã®ã©ã¡ã‚‰ã‹ã«ãªã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šå˜ä¸€ãƒãƒ¼ãƒˆç•ªå·(8080)ã§HTTPã€HTTPSä¸¡æ–¹ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ã¦ã„ã‚‹ã€‚
        ssl_preread on;       # SSLé€šä¿¡æ™‚ã®initial ClientHelloã‚’è¦‹ã‚‹ã‹ã©ã†ã‹ã‚’è¨­å®šã€‚ã“ã‚Œã‚’onã«ã—ãªã„ã¨$ssl_preread_protocolãŒå‹•ä½œã—ãªã„ã€‚
    }
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;

    keepalive_timeout  65;

    include /etc/nginx/conf.d/*.conf;
}
```

ä¸Šè¨˜ã®streamã‹ã‚‰æµã‚Œã¦ãã‚‹é€šä¿¡ã‚’å—ã‘ä»˜ã‘ã‚‹upstreamå´ã®è¨­å®šãŒä»¥ä¸‹ã€‚

#### `/etc/nginx/conf.d/default.conf`

```nginx
upstream app {
    server localhost:8081 max_fails=1 fail_timeout=60
}

server { # upstreamå´ã§HTTPã¨HTTPSã‚’ãã‚Œãã‚Œå—ã‘ä»˜ã‘ã‚‹ãƒãƒ¼ãƒˆã‚’åˆ¥ã§æŒã¤ã€‚
    listen       8083 ssl;
    listen       8082;

    ssl_certificate     path-to-cert-file;
    ssl_certificate_key path-to-key-file;

    server_name  example.com;

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    location / {
        proxy_pass http://app; # æœ€çµ‚çš„ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒã¸è»¢é€ã™ã‚‹
    }
}
```

è¨­å®šå†…å®¹ã®æ„å‘³ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¨ã—ã¦è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

# å‚è€ƒ

* https://www.nginx.com/blog/running-non-ssl-protocols-over-ssl-port-nginx-1-15-2/